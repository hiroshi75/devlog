# DevLog MCP Inspector 統合テストガイド

## 概要

このドキュメントでは、DevLog MCP サーバーの統合テストに MCP Inspector を使用する方法を説明します。Inspector を使用することで、実装したツールとリソースが正しく動作することを手動で確認できます。

## MCP Inspector とは

MCP Inspector は、Model Context Protocol (MCP) サーバーをテストおよびデバッグするためのインタラクティブな開発者ツールです。以下の機能を提供します：

- **ツールの実行テスト**: MCP ツールの動作確認と結果検証
- **リソースのアクセステスト**: リソースの内容確認とアクセス可能性検証
- **エラーハンドリングの確認**: 不正な入力に対する適切なエラー処理の検証
- **ログとメッセージの監視**: サーバーからの通知とログの確認

## セットアップ

### 前提条件

- Node.js (v18 以上)
- Python 3.12 以上
- DevLog プロジェクトの依存関係がインストール済み

### Inspector の起動

DevLog サーバーを Inspector で起動するには、以下のコマンドを実行します：

```bash
# プロジェクトルートディレクトリで実行
npx @modelcontextprotocol/inspector python -m app.main
```

または、uv を使用している場合：

```bash
npx @modelcontextprotocol/inspector uv run python -m app.main
```

成功すると、ブラウザで Inspector UI が開きます。

## 統合テスト結果

### 実行された統合テスト

2025 年 6 月 6 日に包括的な統合テストを実行し、以下の結果を得ました：

**テスト結果サマリー:**

- ✅ 成功: 13/13 (100%)
- ❌ 失敗: 0/13 (0%)
- 📈 成功率: 100.0%

### 発見・修正された問題

#### 1. データベースセッション管理の問題

**問題**: ツールとリソースハンドラーで`next(get_db())`を使用していたが、これは FastAPI 用の依存性注入関数で、直接呼び出すとエラーが発生。

**修正**: 全てのツールとリソースハンドラーで`SessionLocal()`を直接使用するように変更。

**影響ファイル**:

- `app/tools/project_tools.py`
- `app/tools/user_tools.py`
- `app/tools/task_tools.py`
- `app/tools/message_tools.py`
- `app/resources/project_resources.py`
- `app/resources/task_resources.py`
- `app/resources/user_resources.py`
- `app/resources/message_resources.py`

#### 2. モデルの一貫性の問題

**問題**: `User`と`Message`モデルに`updated_at`フィールドが不足していた。

**修正**: 全モデルで一貫して`updated_at`フィールドを追加。

**影響ファイル**:

- `app/models/user.py`
- `app/models/message.py`

#### 3. CRUD 関数の引数名の不一致

**問題**: ツールから CRUD 関数を呼び出す際の引数名が一致していなかった。

**修正**:

- `update_project_tool`: `project_update` → `project`
- `update_task_tool`: `task_update` → `task`

**影響ファイル**:

- `app/tools/project_tools.py`
- `app/tools/task_tools.py`

#### 4. 外部キー制約の問題

**問題**: プロジェクト削除時にメッセージの`project_id`が NOT NULL 制約でエラーが発生。

**修正**:

- `Message`モデルの`project_id`を`nullable=True`に変更
- プロジェクト削除時に関連メッセージの`project_id`を Null に設定
- 関連タスクは削除するように変更

**影響ファイル**:

- `app/models/message.py`
- `app/crud/project.py`

#### 5. タスク作成時の引数順序の問題

**問題**: `create_task_tool`の引数順序がスキーマと一致していなかった。

**修正**: 引数順序を`title, project_id, description, status, assignee_id`に統一。

**影響ファイル**:

- `app/tools/task_tools.py`
- `app/main.py`

### 自動統合テストの実装

手動テストを補完するため、自動統合テストスクリプトを作成しました：

```bash
# 自動統合テストの実行
python -m tests.test_integration_manual
```

このテストは以下の項目を検証します：

1. データベース初期化
2. プロジェクト・ユーザー・タスク・メッセージの作成
3. データ取得とフィルタリング
4. リソースハンドラーの動作
5. 更新操作
6. エラーハンドリング
7. クリーンアップ操作

## テスト手順

### 1. 接続確認

1. Inspector が起動したら、**Connection** タブで接続状態を確認
2. "Connected" ステータスが表示されることを確認
3. エラーメッセージがないことを確認

### 2. ツール（Tools）のテスト

#### プロジェクト管理ツールのテスト

**a) create_project**

1. **Tools** タブを開く
2. `create_project` ツールを選択
3. 以下の引数でテスト：
   ```json
   {
     "name": "テストプロジェクト",
     "description": "Inspector テスト用プロジェクト"
   }
   ```
4. 実行結果に `id`, `name`, `description`, `created_at`, `updated_at` が含まれることを確認

**b) get_projects**

1. `get_projects` ツールを選択
2. 引数なしで実行
3. 作成したプロジェクトが結果に含まれることを確認

**c) get_project**

1. `get_project` ツールを選択
2. 作成したプロジェクトの ID を指定：
   ```json
   {
     "project_id": 1
   }
   ```
3. 正しいプロジェクト情報が返されることを確認

#### ユーザー管理ツールのテスト

**a) create_user**

1. `create_user` ツールを選択
2. 以下の引数でテスト：
   ```json
   {
     "username": "test_user",
     "email": "test@example.com"
   }
   ```
3. ユーザーが正常に作成されることを確認

**b) get_users**

1. `get_users` ツールを選択
2. 引数なしで実行
3. 作成したユーザーが結果に含まれることを確認

#### タスク管理ツールのテスト

**a) create_task**

1. `create_task` ツールを選択
2. 以下の引数でテスト：
   ```json
   {
     "title": "テストタスク",
     "project_id": 1,
     "description": "Inspector テスト用タスク",
     "status": "pending",
     "assignee_id": 1
   }
   ```
3. タスクが正常に作成されることを確認

**b) get_tasks**

1. `get_tasks` ツールを選択
2. フィルタリングのテスト：
   ```json
   {
     "project_id": 1,
     "status": "pending"
   }
   ```
3. 条件に合致するタスクが返されることを確認

#### メッセージ管理ツールのテスト

**a) create_message**

1. `create_message` ツールを選択
2. 以下の引数でテスト：
   ```json
   {
     "content": "テストメッセージです",
     "user_id": 1,
     "message_type": "status_update",
     "task_id": 1,
     "project_id": 1
   }
   ```
3. メッセージが正常に作成されることを確認

### 3. リソース（Resources）のテスト

#### プロジェクトリソース

1. **Resources** タブを開く
2. `project://1` を入力してアクセス
3. プロジェクト情報とタスク数が表示されることを確認

#### タスクリソース

1. `task://1` を入力してアクセス
2. タスクの詳細情報が表示されることを確認

#### ユーザーリソース

1. `user://1` を入力してアクセス
2. ユーザー情報が表示されることを確認

#### メッセージリソース

1. `messages://recent` を入力してアクセス
2. 最新のメッセージが表示されることを確認

### 4. エラーハンドリングのテスト

#### 存在しないリソースへのアクセス

1. `project://999` にアクセス
2. 適切なエラーメッセージが表示されることを確認

#### 不正な引数でのツール実行

1. `create_project` を空の `name` で実行
2. バリデーションエラーが発生することを確認

#### 依存関係の確認

1. 存在しないプロジェクト ID でタスクを作成
2. 外部キー制約エラーが適切に処理されることを確認

### 5. 通知とログの確認

**Notifications** パネルで以下を確認：

- サーバーからのログメッセージ
- エラー通知
- 実行ログのタイムスタンプ
- エラーレベルの適切な分類

## 最低限の統合テストチェックリスト

### 必須テスト項目

- [x] **接続確認**: Inspector とサーバーが正常に接続される
- [x] **基本 CRUD 操作**:
  - [x] プロジェクトの作成・取得・更新・削除
  - [x] ユーザーの作成・取得
  - [x] タスクの作成・取得・更新・削除
  - [x] メッセージの作成・取得
- [x] **リソースアクセス**: 各リソースタイプが正常にアクセスできる
- [x] **エラーハンドリング**: 不正な入力に対して適切なエラーが返される
- [x] **データ整合性**: 関連データが正しく処理される

### 推奨テスト項目

- [x] **フィルタリング**: `get_tasks`, `get_messages` のフィルタリング機能
- [ ] **ページネーション**: 大量データ処理の確認
- [ ] **権限チェック**: 適切なユーザー権限の確認
- [ ] **同時実行**: 複数の操作の同時実行

## トラブルシューティング

### よくある問題

**1. 接続エラー**

- サーバーが正しく起動しているか確認
- ポート番号の競合がないか確認
- 環境変数が正しく設定されているか確認

**2. データベースエラー**

- データベースファイルが存在するか確認
- マイグレーションが実行されているか確認
- 権限設定が正しいか確認

**3. ツール実行エラー**

- 引数の型と形式が正しいか確認
- 必須パラメータが漏れていないか確認
- データベースの整合性を確認

### デバッグのヒント

1. **ログの確認**: Notifications パネルでサーバーログを確認
2. **段階的テスト**: 単純な操作から複雑な操作へ段階的にテスト
3. **データベース状態の確認**: 直接データベースを確認してデータの状態を把握
4. **エラーメッセージの詳細確認**: エラーの詳細情報をもとに原因を特定

## 継続的な統合テスト

### 開発ワークフロー

1. **新機能追加時**

   - 新しいツールやリソースを Inspector でテスト
   - 既存機能への影響がないことを確認

2. **バグ修正時**

   - 修正対象の機能を Inspector で確認
   - 関連機能の動作確認

3. **リファクタリング時**
   - 全体的な機能テストを実行
   - パフォーマンスの変化を確認

### 自動化の準備

Inspector での手動テスト結果をもとに、以下の自動化を実装済み：

- ✅ 包括的な統合テストスクリプト (`tests/test_integration_manual.py`)
- ✅ 全 CRUD 操作の自動検証
- ✅ エラーハンドリングの自動テスト
- ✅ データ整合性の自動確認

将来的な拡張：

- CI/CD パイプラインでの自動テスト実行
- テストカバレッジの計測と改善
- パフォーマンステストの追加

## まとめ

MCP Inspector を使用することで、DevLog MCP サーバーの機能を包括的にテストできます。統合テストにより以下が確認されました：

- **100%の成功率**: 全 13 項目のテストが成功
- **堅牢なエラーハンドリング**: 適切な例外処理とバリデーション
- **データ整合性**: 関連データの正しい処理
- **完全な CRUD 操作**: 作成・読取・更新・削除の全操作が正常動作

このガイドに従って定期的にテストを実行し、サーバーの品質と信頼性を維持してください。

手動テストの結果は自動テスト実装の基盤となり、継続的な品質保証を可能にします。
